# RunPod-Gemini 하이브리드 라우팅 전략 명세서 (Advanced Strategy)

본 전략은 고성능 GPU 인스턴스(RunPod)의 비용 효율성과 관리형 API(Gemini)의 고가용성을 결합하여, 어떠한 상황에서도 지연 시간을 최소화하고 서비스 연속성을 보장하는 것을 목표로 합니다.

---

## 1. 전략적 핵심: 상태 기반 라우팅 (State-Driven Routing)

시스템은 **'인메모리 상태 플래그(In-memory State Flag)'**를 중추로 삼습니다. 이는 백그라운드에서 실시간으로 갱신되는 RunPod의 가용성 지표이며, 사용자 요청이 유입될 때 판단의 근거가 됩니다.



---

## 2. 시나리오별 세부 대응 전략 (Scenario Analysis)

### Case 1: 최적 상태 (RunPod 가동 및 헬스체크 통과)
* **상태:** `is_runpod_available = True`
* **판단 로직:** 모든 트래픽을 RunPod 엔드포인트로 전송합니다.
* **전략적 통찰:** 이미 지불 중인 GPU 자원을 100% 활용하여 추론 비용을 0에 가깝게 유지하고, 미세 조정(Fine-tuning)된 모델의 성능을 온전히 활용합니다.

### Case 2: 인스턴스 기동 단계 (Cold Start / Warm-up)
* **상태:** 인스턴스는 시작되었으나 내부 모델 서버가 로드되지 않음.
* **판단 로직:** 헬스체크가 성공(HTTP 200)을 반환할 때까지 `is_runpod_available`을 `False`로 유지합니다.
* **전략적 통찰:** RunPod 인스턴스가 'Running' 상태라고 해서 즉시 트래픽을 보내면 모델 로딩 시간 동안 타임아웃 오류가 발생합니다. 이 기간에는 Gemini가 모든 요청을 처리하여 사용자가 가동 대기 시간을 느끼지 못하게 합니다.

### Case 3: 런타임 예외 발생 (Transient Failure)
* **상태:** 플래그는 `True`이나, 특정 추론 요청이 OOM(Out of Memory) 또는 네트워크 일시 오류로 실패함.
* **판단 로직:** 즉각적인 **'서킷 브레이커(Circuit Breaker)'** 작동. 해당 요청을 즉시 Gemini로 재시도(Retry)함과 동시에, 전역 플래그를 즉시 `False`로 강제 전환합니다.
* **전략적 통찰:** 5분 주기 체크를 기다리지 않고 실시간 오류에 반응합니다. 이는 한 명의 사용자만 실패를 경험하고, 이후의 사용자는 즉시 안정적인 Gemini 경로로 보호받게 함을 의미합니다.

### Case 4: 계획된 중지 및 가용성 상실 (Planned Stop)
* **상태:** RunPod 인스턴스 종료 또는 5분 주기 헬스체크 실패.
* **판단 로직:** `is_runpod_available`을 `False`로 고정하고 모든 요청을 Gemini로 라우팅합니다.
* **전략적 통찰:** GPU 비용 발생이 중단된 시점부터 시스템은 순수 관리형 서비스 모드로 전환됩니다. 비용은 API 호출 단위로만 발생하며 시스템 가용성은 99.9% 이상 유지됩니다.

### Case 5: 이중 장애 상황 (Total Outage)
* **상태:** RunPod 가용 불가 및 Gemini API 할당량 초과 또는 장애.
* **판단 로직:** 사전에 정의된 '최소 응답(Fallback Response)' 또는 503 Service Unavailable 에러와 함께 `Retry-After` 헤더를 반환합니다.
* **전략적 통찰:** 시스템 전체의 붕괴를 막기 위한 최후의 보루입니다.

---

## 3. 동적 복구 메커니즘 (Auto-Recovery Logic)

전략의 핵심은 **'비대칭적 상태 전환'**에 있습니다.

1.  **Fail-Fast (즉시 차단):** 실제 요청 실패 시 5분 주기를 무시하고 즉시 Gemini로 전환하여 사용자 경험 손실을 최소화합니다.
2.  **Slow-Start (신중한 복구):** 5분마다 실행되는 백그라운드 헬스체크가 연속 2회 이상 성공할 때만 플래그를 `True`로 환원합니다. 이는 인스턴스가 불안정한 상태에서 플래그가 빈번하게 바뀌는 '플래핑(Flapping)' 현상을 방지하기 위함입니다.

---

## 4. 효율성 매트릭스 요약

| 상황 | 기본 경로 (Primary) | 대체 경로 (Secondary) | 사용자 경험 영향 |
| :--- | :--- | :--- | :--- |
| **RunPod 정상** | 실행 | 대기 (비용 0) | 최상 (맞춤형 모델) |
| **RunPod 가동 중** | 차단 | 실행 (Gemini) | 우수 (지연 없음) |
| **RunPod 오류 발생** | 시도 후 차단 | **즉시 전환** | 보통 (1회 지연 발생) |
| **RunPod 중지** | 차단 | 실행 (Gemini) | 우수 (안정적 응답) |

---